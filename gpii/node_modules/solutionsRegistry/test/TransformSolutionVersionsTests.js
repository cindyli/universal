/*
 * Transform Solution Versions Tests
 *
 * Copyright 2020 OCAD University
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";
var fluid = require("infusion"),
    jqUnit = fluid.require("node-jqunit"),
    gpii = fluid.registerNamespace("gpii");

fluid.registerNamespace("gpii.tests.TransformSolutionVersions");

require("../src/js/transformSolutionVersions.js");

gpii.tests.TransformSolutionVersions.testData = {
    os: "win32",
    input: {
        "com.microsoft.windows.desktopBackground": {
            "settingsHandlers": {
                "configureImage": {
                    "type": "gpii.windows.spiSettingsHandler",
                    "supportedSettings": {
                        "TileWallpaper": {
                            "schema": {
                                "title": "Desktop wallpaper tiling",
                                "description": "Sets the wallpaper to tiling style."
                            },
                            "path": {
                                "get": "pvParam",
                                "set": "uiParam"
                            }
                        },
                        "ImageConfig": {
                            "schema": {
                                "title": "Desktop background wallpaper",
                                "description": "The path to the image to be set as the new desktop wallpaper."
                            },
                            "path": "pvParam"
                        }
                    },
                    "capabilitiesTransformations": {
                        "TileWallpaper": {
                            "transform": {
                                "type": "fluid.transforms.valueMapper",
                                "defaultInputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Scaling",
                                "match": {
                                    "Fill": "0",
                                    "Fit": "0",
                                    "Stretch": "0",
                                    "Tile": "1",
                                    "Center": "0",
                                    "Span": "0"
                                },
                                "noMatch": {
                                    "outputValue": "0"
                                }
                            }
                        },
                        "ImageConfig": {
                            "transform": {
                                "type": "fluid.transforms.value",
                                "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                "outputPath": "value"
                            }
                        }
                    }
                }
            }
        }
    },
    expected: {
        "com.microsoft.windows.desktopBackground": {
            "settingsHandlers": {
                "configureImage": {
                    "type": "gpii.windows.spiSettingsHandler",
                    "supportedSettings": {
                        "TileWallpaper": {
                            "schema": {
                                "title": "Desktop wallpaper tiling",
                                "description": "Sets the wallpaper to tiling style.",
                                "properties": {
                                    "path": {
                                        "oneOf": [
                                            { "type":  "string"},
                                            {
                                                "type":  "object",
                                                "properties": {
                                                    "get": { "type":  "string", "required": true },
                                                    "set": { "type":  "string", "required": true }
                                                }
                                            }
                                        ],
                                        "required": true
                                    }
                                }
                            }
                        },
                        "ImageConfig": {
                            "schema": {
                                "title": "Desktop background wallpaper",
                                "description": "The path to the image to be set as the new desktop wallpaper.",
                                "properties": {
                                    "path": {
                                        "oneOf": [
                                            { "type":  "string"},
                                            {
                                                "type":  "object",
                                                "properties": {
                                                    "get": { "type":  "string", "required": true },
                                                    "set": { "type":  "string", "required": true }
                                                }
                                            }
                                        ],
                                        "required": true
                                    }
                                }
                            }
                        }
                    },
                    "capabilitiesTransformations": {
                        "TileWallpaper": {
                            "transform": {
                                "type": "fluid.transforms.valueMapper",
                                "defaultInputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Scaling",
                                "match": {
                                    "Fill": "0",
                                    "Fit": "0",
                                    "Stretch": "0",
                                    "Tile": "1",
                                    "Center": "0",
                                    "Span": "0"
                                },
                                "noMatch": {
                                    "outputValue": "0"
                                }
                            },
                            "path": {
                                "literalValue": {
                                    "get": "pvParam",
                                    "set": "uiParam"
                                }
                            }
                        },
                        "ImageConfig": {
                            "transform": {
                                "type": "fluid.transforms.value",
                                "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                "outputPath": "value"
                            },
                            "path": {
                                "literalValue": "pvParam"
                            }
                        }
                    }
                }
            }
        }
    }
};

jqUnit.test("gpii.solutionsRegistry.transform_win32_2_1() - Transform Windows solutions from Version 2 to 1", function () {
    jqUnit.expect(2);

    var testCases = {
        "actualTransform": {
            message: "Transform path values in a string or an object from supportedSettings to capabilitiesTransformations",
            input: gpii.tests.TransformSolutionVersions.testData.input,
            expected: gpii.tests.TransformSolutionVersions.testData.expected
        },
        "mixed": {
            message: "A mix of solutions that require and don't require the transformation",
            input: {
                "com.freedomscientific.jaws": {
                    "settingsHandlers": {
                        "configureImage": {
                            "type": "gpii.windows.spiSettingsHandler",
                            "supportedSettings": {
                                "ImageConfig": {
                                    "schema": {
                                        "title": "Desktop background wallpaper",
                                        "description": "The path to the image to be set as the new desktop wallpaper.",
                                        "properties": {
                                            "path": { "type":  "string"},
                                            "value": {
                                                "type": "string",
                                                "default": "%SystemRoot%\\Web\\Wallpaper\\Windows\\img0.jpg"
                                            }
                                        }
                                    },
                                    "path": {
                                        "get": "pvParam",
                                        "set": "uiParam"
                                    }
                                }
                            },
                            "capabilitiesTransformations": {
                                "ImageConfig": {
                                    "transform": {
                                        "type": "fluid.transforms.value",
                                        "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                        "outputPath": "value"
                                    }
                                }
                            }
                        }
                    }
                },
                "com.microsoft.windows.desktopBackground": {
                    "settingsHandlers": {
                        "configureImage": {
                            "type": "gpii.windows.spiSettingsHandler",
                            "supportedSettings": {
                                "ImageConfig": {
                                    "schema": {
                                        "title": "Desktop background wallpaper",
                                        "description": "The path to the image to be set as the new desktop wallpaper."
                                    }
                                }
                            },
                            "capabilitiesTransformations": {
                                "ImageConfig": {
                                    "transform": {
                                        "type": "fluid.transforms.value",
                                        "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                        "outputPath": "value"
                                    }
                                }
                            }
                        }
                    }
                }
            },
            expected: {
                "com.freedomscientific.jaws": {
                    "settingsHandlers": {
                        "configureImage": {
                            "type": "gpii.windows.spiSettingsHandler",
                            "supportedSettings": {
                                "ImageConfig": {
                                    "schema": {
                                        "title": "Desktop background wallpaper",
                                        "description": "The path to the image to be set as the new desktop wallpaper.",
                                        "properties": {
                                            "path": {
                                                "oneOf": [
                                                    { "type":  "string"},
                                                    {
                                                        "type":  "object",
                                                        "properties": {
                                                            "get": { "type":  "string", "required": true },
                                                            "set": { "type":  "string", "required": true }
                                                        }
                                                    }
                                                ],
                                                "required": true
                                            },
                                            "value": {
                                                "type": "string",
                                                "default": "%SystemRoot%\\Web\\Wallpaper\\Windows\\img0.jpg"
                                            }
                                        }
                                    }
                                }
                            },
                            "capabilitiesTransformations": {
                                "ImageConfig": {
                                    "transform": {
                                        "type": "fluid.transforms.value",
                                        "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                        "outputPath": "value"
                                    },
                                    "path": {
                                        "literalValue": {
                                            "get": "pvParam",
                                            "set": "uiParam"
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                "com.microsoft.windows.desktopBackground": {
                    "settingsHandlers": {
                        "configureImage": {
                            "type": "gpii.windows.spiSettingsHandler",
                            "supportedSettings": {
                                "ImageConfig": {
                                    "schema": {
                                        "title": "Desktop background wallpaper",
                                        "description": "The path to the image to be set as the new desktop wallpaper."
                                    }
                                }
                            },
                            "capabilitiesTransformations": {
                                "ImageConfig": {
                                    "transform": {
                                        "type": "fluid.transforms.value",
                                        "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                        "outputPath": "value"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    };

    fluid.each(testCases, function (oneTest) {
        var result = gpii.solutionsRegistry.transform_win32_2_1(oneTest.input);
        jqUnit.assertDeepEq(oneTest.message, oneTest.expected, result);
    });
});

jqUnit.test("gpii.solutionsRegistry.transformSolutionsBtwVersions() - Transform in between versions", function () {
    jqUnit.expect(5);

    var testCases = {
        "highToLow": {
            message: "Solutions are transformed successfully from a higher version to a lower version",
            os: "win32",
            fromVersion: 2,
            toVersion: 1,
            inputSolutions: gpii.tests.TransformSolutionVersions.testData.input,
            expectedSolutions: gpii.tests.TransformSolutionVersions.testData.expected
        },
        "equalVersions": {
            message: "Original solutions are returned when the from and the to versions are the same",
            os: "win32",
            fromVersion: 1,
            toVersion: 1,
            inputSolutions: gpii.tests.TransformSolutionVersions.testData.input,
            expectedSolutions: gpii.tests.TransformSolutionVersions.testData.input
        },
        "LowToHigh": {
            message: "Original solutions are returned when the from version is lower than the to version",
            os: "win32",
            fromVersion: 1,
            toVersion: 2,
            inputSolutions: gpii.tests.TransformSolutionVersions.testData.input,
            expectedSolutions: gpii.tests.TransformSolutionVersions.testData.input
        },
        "invalidVersions": {
            message: "Original solutions are returned when the from and the to versions are the same",
            os: "win32",
            fromVersion: "invalidFrom",
            toVersion: "invalidTo",
            inputSolutions: gpii.tests.TransformSolutionVersions.testData.input,
            expectedSolutions: gpii.tests.TransformSolutionVersions.testData.input
        },
        "invalidOS": {
            message: "Original solutions are returned when the from and the to versions are the same",
            os: "invalid",
            fromVersion: 2,
            toVersion: 1,
            inputSolutions: gpii.tests.TransformSolutionVersions.testData.input,
            expectedSolutions: gpii.tests.TransformSolutionVersions.testData.input
        }
    };

    fluid.each(testCases, function (oneTest) {
        var result = gpii.solutionsRegistry.transformSolutionsBtwVersions(oneTest.inputSolutions, oneTest.os, oneTest.fromVersion, oneTest.toVersion);
        jqUnit.assertDeepEq(oneTest.message, oneTest.expectedSolutions, result);
    });
});
