/*
 * Transform Solution Versions Tests
 *
 * Copyright 2020 OCAD University
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";
var fluid = require("infusion"),
    jqUnit = fluid.require("node-jqunit"),
    gpii = fluid.registerNamespace("gpii");

fluid.registerNamespace("gpii.tests.TransformSolutionVersions");

require("../src/js/transformSolutionVersions.js");

jqUnit.test("gpii.solutionsRegistry.transform_2_1() - Transform from Version 2 to 1", function () {
    jqUnit.expect(3);

    var testCases = {
        "stringPath": {
            message: "Transform a string path from supportedSettings to capabilitiesTransformations",
            input: {
                "com.microsoft.windows.desktopBackground": {
                    "settingsHandlers": {
                        "configureImage": {
                            "type": "gpii.windows.spiSettingsHandler",
                            "supportedSettings": {
                                "ImageConfig": {
                                    "schema": {
                                        "title": "Desktop background wallpaper",
                                        "description": "The path to the image to be set as the new desktop wallpaper."
                                    },
                                    "path": "pvParam"
                                }
                            },
                            "capabilitiesTransformations": {
                                "ImageConfig": {
                                    "transform": {
                                        "type": "fluid.transforms.value",
                                        "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                        "outputPath": "value"
                                    }
                                }
                            }
                        }
                    }
                }
            },
            expected: {
                "com.microsoft.windows.desktopBackground": {
                    "settingsHandlers": {
                        "configureImage": {
                            "type": "gpii.windows.spiSettingsHandler",
                            "supportedSettings": {
                                "ImageConfig": {
                                    "schema": {
                                        "title": "Desktop background wallpaper",
                                        "description": "The path to the image to be set as the new desktop wallpaper."
                                    }
                                }
                            },
                            "capabilitiesTransformations": {
                                "ImageConfig": {
                                    "transform": {
                                        "type": "fluid.transforms.value",
                                        "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                        "outputPath": "value"
                                    },
                                    "path": {
                                        "literalValue": "pvParam"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        "nestedPath": {
            message: "Transform a nested path from supportedSettings to capabilitiesTransformations",
            input: {
                "com.microsoft.windows.desktopBackground": {
                    "settingsHandlers": {
                        "configureImage": {
                            "type": "gpii.windows.spiSettingsHandler",
                            "supportedSettings": {
                                "ImageConfig": {
                                    "schema": {
                                        "title": "Desktop background wallpaper",
                                        "description": "The path to the image to be set as the new desktop wallpaper."
                                    },
                                    "path": {
                                        "get": "pvParam",
                                        "set": "uiParam"
                                    }
                                }
                            },
                            "capabilitiesTransformations": {
                                "ImageConfig": {
                                    "transform": {
                                        "type": "fluid.transforms.value",
                                        "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                        "outputPath": "value"
                                    }
                                }
                            }
                        }
                    }
                }
            },
            expected: {
                "com.microsoft.windows.desktopBackground": {
                    "settingsHandlers": {
                        "configureImage": {
                            "type": "gpii.windows.spiSettingsHandler",
                            "supportedSettings": {
                                "ImageConfig": {
                                    "schema": {
                                        "title": "Desktop background wallpaper",
                                        "description": "The path to the image to be set as the new desktop wallpaper."
                                    }
                                }
                            },
                            "capabilitiesTransformations": {
                                "ImageConfig": {
                                    "transform": {
                                        "type": "fluid.transforms.value",
                                        "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                        "outputPath": "value"
                                    },
                                    "path": {
                                        "literalValue": {
                                            "get": "pvParam",
                                            "set": "uiParam"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        "mixed": {
            message: "A mix of solutions that require and doesn't require the transformation",
            input: {
                "com.freedomscientific.jaws": {
                    "settingsHandlers": {
                        "configureImage": {
                            "type": "gpii.windows.spiSettingsHandler",
                            "supportedSettings": {
                                "ImageConfig": {
                                    "schema": {
                                        "title": "Desktop background wallpaper",
                                        "description": "The path to the image to be set as the new desktop wallpaper.",
                                        // TODO: Discuss somehow simplifying the structure of SPI settings for easier UI input.
                                        "properties": {
                                            "path": { "type":  "string"},
                                            "value": {
                                                "type": "string",
                                                "default": "%SystemRoot%\\Web\\Wallpaper\\Windows\\img0.jpg"
                                            }
                                        }
                                    },
                                    "path": {
                                        "get": "pvParam",
                                        "set": "uiParam"
                                    }
                                }
                            },
                            "capabilitiesTransformations": {
                                "ImageConfig": {
                                    "transform": {
                                        "type": "fluid.transforms.value",
                                        "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                        "outputPath": "value"
                                    }
                                }
                            }
                        }
                    }
                },
                "com.microsoft.windows.desktopBackground": {
                    "settingsHandlers": {
                        "configureImage": {
                            "type": "gpii.windows.spiSettingsHandler",
                            "supportedSettings": {
                                "ImageConfig": {
                                    "schema": {
                                        "title": "Desktop background wallpaper",
                                        "description": "The path to the image to be set as the new desktop wallpaper."
                                    }
                                }
                            },
                            "capabilitiesTransformations": {
                                "ImageConfig": {
                                    "transform": {
                                        "type": "fluid.transforms.value",
                                        "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                        "outputPath": "value"
                                    }
                                }
                            }
                        }
                    }
                }
            },
            expected: {
                "com.freedomscientific.jaws": {
                    "settingsHandlers": {
                        "configureImage": {
                            "type": "gpii.windows.spiSettingsHandler",
                            "supportedSettings": {
                                "ImageConfig": {
                                    "schema": {
                                        "title": "Desktop background wallpaper",
                                        "description": "The path to the image to be set as the new desktop wallpaper.",
                                        // TODO: Discuss somehow simplifying the structure of SPI settings for easier UI input.
                                        "properties": {
                                            "path": { "type":  "string"},
                                            "value": {
                                                "type": "string",
                                                "default": "%SystemRoot%\\Web\\Wallpaper\\Windows\\img0.jpg"
                                            }
                                        }
                                    }
                                }
                            },
                            "capabilitiesTransformations": {
                                "ImageConfig": {
                                    "transform": {
                                        "type": "fluid.transforms.value",
                                        "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                        "outputPath": "value"
                                    },
                                    "path": {
                                        "literalValue": {
                                            "get": "pvParam",
                                            "set": "uiParam"
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                "com.microsoft.windows.desktopBackground": {
                    "settingsHandlers": {
                        "configureImage": {
                            "type": "gpii.windows.spiSettingsHandler",
                            "supportedSettings": {
                                "ImageConfig": {
                                    "schema": {
                                        "title": "Desktop background wallpaper",
                                        "description": "The path to the image to be set as the new desktop wallpaper."
                                    }
                                }
                            },
                            "capabilitiesTransformations": {
                                "ImageConfig": {
                                    "transform": {
                                        "type": "fluid.transforms.value",
                                        "inputPath": "http://registry\\.gpii\\.net/applications/com\\.microsoft\\.windows\\.desktopBackground.Image",
                                        "outputPath": "value"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    };

    fluid.each(testCases, function (oneTest) {
        var result = gpii.solutionsRegistry.transform_2_1(oneTest.input);
        jqUnit.assertDeepEq(oneTest.message, oneTest.expected, result);
    });
});
